=== EVA-Finance Engineering Continuation Snapshot ===

PROJECT PURPOSE

EVA-Finance detects consumer behavioral trends from Reddit discussions and validates them as investment signals through paper trading. The system ingests Reddit data via n8n workflows, extracts brand mentions and behavioral tags using LLM processing, scores signals through confidence modeling, generates AI-approved recommendations, and automatically creates paper trading positions to validate forward-looking performance. In scope: Reddit ingestion, LLM extraction, confidence scoring, AI approval, notification pipeline, paper trading validation. Out of scope: Real capital deployment, multi-source fusion (Twitter/Discord), e-commerce velocity tracking, historical backtesting (Reddit API access denied).

MENTAL MODEL / EXECUTION ASSUMPTIONS

- PostgreSQL runs in Docker container at 172.20.0.2:5432 (not localhost)
- All database connections from host scripts must use 172.20.0.2
- eva-worker container has volume mount to /home/koolhand/projects/eva-finance/scripts:ro for paper trading access
- Paper trading uses simulated $1000 positions per signal, no real capital
- Exit rules: 90 days (time), +15% (profit target), -10% (stop loss)
- Validation criteria: Win rate ≥50%, Avg return ≥5%, ≥10 closed trades
- Many brands map to private companies (BRAND_TO_TICKER returns None) - these are skipped
- Signal events use UNIQUE index on (event_type, tag, brand, day) to prevent duplicates
- Notification pipeline triggers paper trade entry via subprocess after AI approval
- Cron jobs run on host machine (not in containers) at 4:00 PM and 4:05 PM ET weekdays
- yfinance returns float, PostgreSQL returns Decimal - explicit type conversion required
- ROADMAP.md defines 12-week Phase 0 validation roadmap (Week 1-12 structure)

CURRENT ARCHITECTURE

**Ingest sources:**
- n8n workflow polls Reddit subreddits (BuyItForLife, Frugal, running, sneakers, malefashionadvice, femalefashionadvice, goodyearwelt, onebag)
- Posts inserted into raw_messages table (981 messages currently)

**Processing pipeline:**
- eva-worker processes raw_messages → LLM extracts brands/tags → processed_messages
- eva_confidence_v1.py runs daily (1:05 AM cron) → computes confidence scores → behavior_states, brand_mentions tables
- worker.py emit_trigger_events() → creates signal_events from v_trigger_tag_elevated and v_trigger_brand_divergence
- reco_runner.py generates markdown recommendations for RECOMMENDATION_ELIGIBLE signals → recommendation_drafts table
- ai_approval.py evaluates recommendations using gpt-4o-mini → sets notify_ready flag
- notify.py polls recommendation_drafts for notify_ready=true → sends ntfy notifications → triggers paper_trade_entry.py

**Workers / schedulers:**
- eva-worker container: Runs worker.py with notification polling (60s interval)
- Cron (host): eva_confidence_v1.py daily at 1:05 AM
- Cron (host): update_paper_prices.py weekdays 4:00 PM (market close)
- Cron (host): check_paper_exits.py weekdays 4:05 PM

**Persistence layer (key tables):**
- raw_messages: Reddit data from n8n (981 rows)
- processed_messages: LLM-extracted brands/tags (981 rows)
- signal_events: Trigger events (2603 rows, includes TAG_ELEVATED, BRAND_DIVERGENCE, RECOMMENDATION_ELIGIBLE)
- recommendation_drafts: AI-approved recommendations (5 rows)
- paper_trades: Simulated positions (0 rows - no trades created yet)
- behavior_states: Tag confidence scores
- brand_mentions: Brand frequency tracking

**Output artifacts:**
- Markdown recommendation reports (generated by reco_runner.py)
- Gzipped evidence bundles (evidence.json.gz)
- ntfy notifications (http://localhost:8085)
- Paper trading logs (/home/koolhand/logs/eva/paper_*.log)

WHAT IS WORKING (END-TO-END)

- n8n Reddit ingestion → raw_messages (981 messages collected Jan 1-8, 2026)
- LLM processing → brand/tag extraction → processed_messages (100% completion)
- Confidence scoring → behavior_states → signal_events generation (2603 events)
- Recommendation generation for RECOMMENDATION_ELIGIBLE signals (5 drafts created)
- AI approval evaluation using gpt-4o-mini (approve/reject decisions with reasoning)
- Notification pipeline → ntfy alerts when notify_ready=true
- Paper trading entry triggered automatically after notifications (subprocess integration)
- Cron automation for daily price updates and exit checks (scheduled, not yet tested with live positions)
- Database migrations applied successfully (002-005)
- Docker Compose stack running (eva_db, eva_worker, eva_ntfy, eva-api, metabase)
- Git version control with recent commits pushed to GitHub

WHAT IS PARTIALLY WORKING

- Paper trading system deployed but 0 positions created (all test signals were private companies like Patagonia, Carhartt)
- Brand-to-ticker mapping incomplete - many consumer brands return None (New Balance, Patagonia, Carhartt, North Face conglomerate issues)
- Cron jobs configured but untested with actual open positions (need public company signals to validate)
- Metabase dashboard exists but not configured with paper trading views
- Historical backtest script exists (scripts/backtest/historical_backtest.py) but found 0 trends (only 8 days of data, needs 365 days)
- PRAW backfill script created (reddit_praw_backfill.py) but waiting for Reddit API credentials

KNOWN ISSUES / BUGS

- BRAND_TO_TICKER mapping has gaps for private companies - need expanded public company coverage (20 brands → 30+ brands target)
- Type mismatch errors fixed (PostgreSQL Decimal vs yfinance float) but requires explicit float() conversion everywhere
- yf.download() deprecated show_errors parameter removed (fixed in update_paper_prices.py)
- worker.py shows deleted eva_worker/notify.py in git status (file moved to eva_worker/eva_worker/notify.py, stale reference)
- No validation with actual open positions yet - paper trading untested end-to-end with market data
- Reddit API access denied - cannot perform historical backtest validation with real 365-day data
- Some signals may not be materially significant (e.g., North Face = <20% of VFC revenue) - materiality scoring not implemented

CURRENT FOCAL PROBLEM

System is fully operational but generating zero paper trading positions because detected brands are predominantly private companies. Need to either: (1) expand BRAND_TO_TICKER mapping to include more publicly-traded consumer brands, (2) wait for signals from existing public brands (Hoka/DECK, On Running/ONON, Lululemon/LULU, Crocs/CROX, etc.), or (3) tune signal detection to favor public companies. This blocks validation of paper trading system with real market data. Without open positions, cannot verify cron automation, price updates, exit checks, or 12-week validation roadmap progress.

RECENT CHANGES

**Last 2 commits (pushed to GitHub):**
- 187adac: Add ROADMAP.md for Phase 0 validation planning (12-week roadmap, validation criteria, weekly milestones)
- 61c874a: Add paper trading system for forward-looking validation (005_paper_trading_system.sql migration, paper_trade_entry.py, update_paper_prices.py, check_paper_exits.py, docker-compose.yml volume mount, yfinance dependency, notify.py subprocess integration)

**Uncommitted changes:**
- eva_worker/worker.py: Debug logging additions (print statements for notification poll debugging)
- eva_worker/notify.py: Deleted file reference (moved to eva_worker/eva_worker/notify.py)
- db/migrations/004_add_unique_constraint_for_backfill.sql: Untracked migration file

**Operational changes:**
- Cron jobs added for daily paper trading automation (4:00 PM and 4:05 PM weekdays)
- Docker volume mount added to eva-worker container for scripts access
- yfinance added to eva_worker/requirements.txt and container rebuilt

NEXT STEPS (ORDERED)

1. Expand BRAND_TO_TICKER mapping in scripts/paper_trading/paper_trade_entry.py with 10+ additional publicly-traded consumer brands (athletic, outdoor, fashion categories)
2. Configure Metabase dashboard with v_paper_trading_performance, v_open_positions, v_closed_positions views for real-time monitoring (Week 1 ROADMAP.md task)
3. Wait for signal detection on public company brands or manually test paper_trade_entry.py with synthetic signal_event_id to validate end-to-end flow
4. Verify cron automation works correctly when first position opens (check logs at /home/koolhand/logs/eva/paper_*.log)
5. Implement brand materiality scoring (Week 4 ROADMAP.md task) to weight high-materiality brands (>20% parent revenue) higher in confidence scoring
6. Set up Google Trends integration (Week 1 ROADMAP.md task) for cross-validation of social signals with search interest

INVARIANTS / RULES

- Paper trades table has UNIQUE constraint on signal_event_id (one paper trade per signal)
- signal_events table has UNIQUE index on (event_type, tag, brand, day) to prevent duplicate triggers
- Exit rules immutable for Phase 0: 90 days OR +15% OR -10% (do not change without invalidating comparison)
- Position size fixed at $1000 per trade for consistency
- Database connections from host must use 172.20.0.2 (Docker container IP), never localhost
- Cron jobs run on host machine, not inside containers (scripts must access database via 172.20.0.2)
- Volume mount is read-only (:ro) - scripts cannot write to container filesystem
- Paper trading logs written to /home/koolhand/logs/eva/ (not /var/log/eva - permission issues)
- Do not modify docs/context/snapshots/EVA_CONTEXT_SNAPSHOT_PROMPT.md (this file is the prompt, not the output)
- Validation criteria for Phase 1 GO decision: Win rate ≥50%, Avg return ≥5%, ≥10 closed trades (Week 12 ROADMAP.md)

KEY FILE LOCATIONS

**Paper trading system:**
- scripts/paper_trading/paper_trade_entry.py (creates positions, BRAND_TO_TICKER mapping)
- scripts/paper_trading/update_paper_prices.py (daily price updater, yfinance integration)
- scripts/paper_trading/check_paper_exits.py (exit rule checker)
- db/migrations/005_paper_trading_system.sql (schema, views, triggers)

**Worker and notification pipeline:**
- eva_worker/worker.py (main worker loop, emit_trigger_events, notification polling)
- eva_worker/eva_worker/notify.py (notification polling, paper trade subprocess trigger)
- eva_worker/eva_worker/ai_approval.py (LLM-based recommendation evaluation)
- eva_worker/eva_worker/reco_runner.py (markdown recommendation generation)
- eva_worker/eva_worker/generate.py (LLM extraction logic)

**Configuration:**
- docker-compose.yml (service definitions, volume mounts, environment variables)
- eva_worker/requirements.txt (Python dependencies including yfinance)
- .env (credentials, API keys, database config)

**Documentation:**
- ROADMAP.md (12-week Phase 0 validation roadmap)
- docs/context/snapshots/EVA_CONTEXT_SNAPSHOT.md (this file)
- docs/context/snapshots/EVA_CONTEXT_SNAPSHOT_PROMPT.md (generation prompt - do not modify)

**Backtest and data collection:**
- scripts/backtest/historical_backtest.py (backtest validation script)
- scripts/backtest/reddit_praw_backfill.py (PRAW-based historical data collection - waiting for credentials)

QUICK START (RESTORE CONTEXT)

**Verify system health:**
```bash
cd /home/koolhand/projects/eva-finance
docker ps  # Verify eva_db, eva_worker, eva_ntfy, eva-api running
docker logs eva_worker --tail 50  # Check worker activity
crontab -l | grep paper  # Verify cron jobs configured
```

**Inspect current state:**
```bash
# Check data pipeline
docker exec eva_db psql -U eva -d eva_finance -c "
SELECT COUNT(*) as count, 'raw_messages' as table FROM raw_messages
UNION ALL SELECT COUNT(*), 'processed_messages' FROM processed_messages
UNION ALL SELECT COUNT(*), 'signal_events' FROM signal_events
UNION ALL SELECT COUNT(*), 'recommendation_drafts' FROM recommendation_drafts
UNION ALL SELECT COUNT(*), 'paper_trades' FROM paper_trades;
"

# Check paper trading performance
docker exec eva_db psql -U eva -d eva_finance -c "SELECT * FROM v_paper_trading_performance;"

# Check open positions
docker exec eva_db psql -U eva -d eva_finance -c "SELECT * FROM v_open_positions;"

# Check recent signals
docker exec eva_db psql -U eva -d eva_finance -c "
SELECT id, event_type, brand, tag, day, severity
FROM signal_events
ORDER BY created_at DESC
LIMIT 10;
"
```

**Run critical manual steps (if needed):**
```bash
# Test paper trade entry manually
cd /home/koolhand/projects/eva-finance/scripts/paper_trading
python3 paper_trade_entry.py

# Test price updater (will fail if no open positions)
python3 update_paper_prices.py

# Test exit checker
python3 check_paper_exits.py

# Check paper trading logs
tail -f /home/koolhand/logs/eva/paper_prices.log
tail -f /home/koolhand/logs/eva/paper_exits.log
```

**Git status:**
```bash
git status  # Check uncommitted changes
git log --oneline -5  # Recent commits
```

ENVIRONMENT

- **OS:** Linux (Ubuntu-based, kernel 6.8.0-90-generic)
- **Runtime versions:**
  - Python: 3.12 (eva_worker container and host)
  - PostgreSQL: 16 (Docker container)
  - Docker Compose: v2.x
- **Services:**
  - eva_db (postgres:16) - port 5432 internal, IP 172.20.0.2
  - eva_worker (Python worker) - runs worker.py with notification polling
  - eva_ntfy (ntfy server) - port 8085 exposed
  - eva-api (FastAPI) - port 9080 exposed
  - eva_metabase (Metabase) - port 3000 exposed
- **External dependencies:**
  - OpenAI API (gpt-4o-mini for LLM extraction and AI approval)
  - yfinance (Yahoo Finance API for stock prices)
  - n8n (Reddit workflow ingestion) - http://10.10.0.210:5678/
- **Cron schedule:**
  - 1:05 AM daily: eva_confidence_v1.py (confidence scoring)
  - 4:00 PM Mon-Fri: update_paper_prices.py (price updates)
  - 4:05 PM Mon-Fri: check_paper_exits.py (exit rule checks)

STATUS

Phase 0 validation system fully operational but blocked on generating paper trading positions from public company signals (0 positions created, need brand coverage expansion or public brand signals).

LAST UPDATED

2026-01-09
